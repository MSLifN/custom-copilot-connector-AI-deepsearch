{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "repoUrl": {
      "type": "string",
      "metadata": {
        "description": "The URL for the GitHub repository containing the Bicep files (e.g., https://github.com/username/repo)."
      }
    },
    "branch": {
      "type": "string",
      "defaultValue": "main",
      "metadata": {
        "description": "The branch of the repository to deploy from (e.g., main)."
      }
    }
    // Add parameters from main.parameters.json that you want the user to override during portal deployment
    // For simplicity, this example relies on the parameters file in the repo, but you could expose them here.
    // Example:
    // "webAppName": {
    //   "type": "string",
    //   "metadata": {
    //     "description": "Unique name for the Web App."
    //   }
    // }
  },
  "variables": {
    // Construct the URI to the Bicep template and parameters file within the specified repo and branch
    "bicepTemplateUri": "[uri(parameters(\'repoUrl\'), concat(\'raw/\', parameters(\'branch\'), \'/infra/main.bicep\'))]",
    "bicepParametersUri": "[uri(parameters(\'repoUrl\'), concat(\'raw/\', parameters(\'branch\'), \'/infra/main.parameters.json\'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "bicepInfraDeployment",
      "properties": {
        "mode": "Incremental", // Use Incremental mode
        "templateLink": {
          "uri": "[variables(\'bicepTemplateUri\')]",
          "contentVersion": "1.0.0.0"
        },
        "parametersLink": {
          "uri": "[variables(\'bicepParametersUri\')]",
          "contentVersion": "1.0.0.0"
        }
        // If you exposed parameters above (like webAppName), map them here:
        // "parameters": {
        //   "webAppName": { "value": "[parameters(\'webAppName\')]" }
        // }
      }
    }
    // NOTE: This template only deploys the Bicep infrastructure.
    // It does NOT automatically deploy the application code from src/ or run the index setup script.
    // Further steps (secrets config, index setup, app deploy) are still required post-infrastructure deployment.
    // For full CI/CD, consider Azure DevOps or GitHub Actions.
  ],
  "outputs": {
    "deployedWebAppHostName": {
        "type": "string",
        "value": "[reference(\'bicepInfraDeployment\').outputs.webAppHostName.value]",
        "metadata": {
            "description": "The hostname of the deployed Web App."
        }
    }
  }
}

